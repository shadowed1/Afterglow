#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

if [ -f "$HOME/opt/.flatpak.env" ]; then
    . "$HOME/opt/.flatpak.env"
fi

starman() {
    local URL="$1"

    if [[ -z "$URL" ]]; then
        echo "${RED}Error: You must provide a URL to download.${RESET}" >&2
        echo "Usage: starman https://archlinux.org/packages/extra/x86_64/composefs/download ~/opt/flatpak-deps"
        return 1
    fi

    local FILE="$HOME/$(basename "$URL")"
    local EXPORT_PATH="${STARMAN_EXPORT_PATH:-$HOME/opt/bin}"
    echo "${YELLOW}Downloading to: $FILE${RESET}"
    curl -L "$URL" -o "$FILE"

    if [[ ! -f "$FILE" ]]; then
        echo "${RED}Failed to download file.${RESET}" >&2
        return 1
    fi

    mkdir -p "$EXPORT_PATH"
    echo "${YELLOW}Extracting to: $EXPORT_PATH"
    tar --use-compress-program=unzstd -xvf "$FILE" -C "$EXPORT_PATH"
    echo "Cleaning up..."
    rm -f "$FILE"
    echo "Done.${RESET}"
}

show_help() {
    echo "${YELLOW}"
    echo "Commands with examples:"
    echo "starman https://archlinux.org/packages/extra/x86_64/composefs/download ~/opt/flatpak-deps"
    echo "Default path if unset: ~/opt/bin"
    echo "${RESET}"
}

zenity_launcher() {
    local CHOICE
    CHOICE=$(zenity --list --title="Aurora Desktop" \
      --width=900 --height=700 \
      --column="Action" --column="Description" \
      "Open File" "Select a file to open with file picker" \
      "Inkscape" "Launch Inkscape via Flatpak" \
      "Download a .tar.zst file" \
      "Exit" "Close this menu")

    case "$CHOICE" in
      "Open File")
        zenity --file-selection --title="Pick a file"
        ;;
        "Download a .tar.zst file")
            FILE_URL=$(zenity --entry --title="Download .tar.zst" --text="Enter the URL of the .tar.zst file:")
            if [ -n "$FILE_URL" ]; then
              starman "$FILE_URL"
            fi
        ;;
      "Inkscape")
        flatpak --user run org.inkscape.Inkscape &
        ;;
      "Exit" | *)
        exit 0
        ;;
    esac
}

# MAIN LOGIC

case "$1" in
    starman)
        shift
        starman "$@"
        ;;
    --h|-h|help)
        show_help
        ;;
    ""|status)
        zenity_launcher
        ;;
    *)
        echo "${RED}Unknown command '$1'${RESET}"
        show_help
        exit 1
        ;;
esac
