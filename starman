#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

if [ -f "$HOME/opt/.flatpak.env" ]; then
    . "$HOME/opt/.flatpak.env"
fi

update_app_list_cache() {
    flatpak --user list --columns=application,name | tail -n +1 | sort -u > "$HOME/.starman_flatpak_cache"
}

starman() {
    local URL="$1"

    if [[ -z "$URL" ]]; then
        echo "${RED}Error: You must provide a URL to download.${RESET}" >&2
        echo "Usage: starman https://archlinux.org/packages/extra/x86_64/composefs/download ~/opt/flatpak-deps"
        return 1
    fi

    local FILE="$HOME/$(basename "$URL")"
    local EXPORT_PATH="${STARMAN_EXPORT_PATH:-$HOME/opt/bin}"
    echo "${YELLOW}Downloading to: $FILE${RESET}"
    curl -L "$URL" -o "$FILE"

    if [[ ! -f "$FILE" ]]; then
        echo "${RED}Failed to download file.${RESET}" >&2
        return 1
    fi

    mkdir -p "$EXPORT_PATH"
    echo "${YELLOW}Extracting to: $EXPORT_PATH${RESET}"

    local ext="${FILE##*.}"
    local decompress_cmd=""

    case "$FILE" in
        *.tar.gz|*.tgz)     decompress_cmd="gzip -d" ;;
        *.tar.bz2|*.tbz2)   decompress_cmd="bzip2 -d" ;;
        *.tar.xz|*.txz)     decompress_cmd="xz -d" ;;
        *.tar.zst|*.tzst)   decompress_cmd="unzstd" ;;
        *.tar.lz4)          decompress_cmd="lz4 -d" ;;
        *.tar.lzma)         decompress_cmd="lzma -d" ;;
        *.tar.lz)           decompress_cmd="lzip -d" ;;
        *.tar.Z)            decompress_cmd="uncompress" ;;
        *.tar)              decompress_cmd="" ;;
        *)
            echo "${RED}Unknown compression format: $FILE${RESET}" >&2
            return 1
            ;;
    esac

    if [[ -n "$decompress_cmd" ]]; then
        tar --use-compress-program="$decompress_cmd" -xvf "$FILE" -C "$EXPORT_PATH"
    else
        tar -xvf "$FILE" -C "$EXPORT_PATH"
    fi

    echo "Cleaning up..."
    rm -f "$FILE"
    echo "${GREEN}Done.${RESET}"
}



show_help() {
    echo "${YELLOW}"
    echo "Commands with examples:"
    eco ""
    echo "starman https://archlinux.org/packages/extra/x86_64/composefs/download ~/opt/flatpak-deps"
    echo "Default path if unset: ~/opt/bin"
    echo "${RESET}"
}

zenity_launcher() {
    local ICON_SIZES=("256" "128")
    local ICON_OUTPUT_BASE="$HOME/.local/share/icons/hicolor"
    local APP_LIST_FILE="$HOME/.starman_flatpak_cache"
    local MENU_ENTRIES=()

    MENU_ENTRIES+=("open_file" "Open File - Browse or open a file")
    MENU_ENTRIES+=("download_archive" "Download Archive - Download and extract .tar.* file (starman)")


    update_app_list_cache

    while IFS=$'\t' read -r APPID NAME; do
        [[ -z "$APPID" || "$APPID" == "Application" ]] && continue

        local ICON_PATH=""
        for SIZE in "${ICON_SIZES[@]}"; do
            local TRY_ICON="$ICON_OUTPUT_BASE/${SIZE}x${SIZE}/apps/$APPID.png"
            if [[ -f "$TRY_ICON" ]]; then
                ICON_PATH="$TRY_ICON"
                break
            fi
        done

        if [[ -n "$ICON_PATH" ]]; then
            MENU_ENTRIES+=("$APPID" "Launch $NAME via Flatpak")
        fi

    done < "$APP_LIST_FILE"

    MENU_ENTRIES+=("Exit" "Close this menu")

    local CHOICE
    CHOICE=$(zenity --list --title="Starman App Launcher" \
      --width=800 --height=600 \
      --column="Action" --column="Description" \
      "${MENU_ENTRIES[@]}")
       case "$CHOICE" in
        open_file)
            zenity --file-selection --title="Browse"
            ;;
        download_archive)
            FILE_URL=$(zenity --entry --title="Starman Archive Downloader:" --text="Enter the URL of the .tar archive and your path of choice:")
            if [[ -n "$FILE_URL" ]]; then
                starman "$FILE_URL"
            fi
            ;;
        Exit|"")
            exit 0
            ;;
        *)
            flatpak --user run "$CHOICE" &
            ;;
    esac

}


reset_app_list() {
    rm -f "$HOME/.starman_flatpak_cache"
    echo "${YELLOW}Flatpak app list cache cleared.${RESET}"
}

set_default_app() {
    local APP_LIST_FILE="$HOME/.starman_flatpak_cache"
    update_app_list_cache

    mapfile -t APPS < <(cut -f1 "$APP_LIST_FILE")
    mapfile -t NAMES < <(cut -f2 "$APP_LIST_FILE")

    echo "Installed Flatpak apps:"
    for i in "${!APPS[@]}"; do
        echo "[$i] ${NAMES[i]} (${APPS[i]})"
    done

    echo
    read -rp "Enter the number of the app to set as default: " appnum
    if ! [[ "$appnum" =~ ^[0-9]+$ ]] || (( appnum < 0 || appnum >= ${#APPS[@]} )); then
        echo "Invalid selection."
        return 1
    fi

    local selected_app="${APPS[appnum]}"
    local desktop_file="${selected_app}.desktop"
    echo "Selected app: ${NAMES[appnum]} ($desktop_file)"

    echo ""
    echo "Enter the extension to assign; separate by commas."
    echo "Examples: .html, .pdf, mp3, http, https"
    read -rp "Extensions/schemes: " extlist

    IFS=',' read -ra extensions <<< "$extlist"

    for ext in "${extensions[@]}"; do
        ext="${ext#"${ext%%[![:space:]]*}"}"
        ext="${ext%"${ext##*[![:space:]]}"}"

        ext="${ext#.}"

        if [[ -z "$ext" ]]; then
            echo "Skipping empty extension"
            continue
        fi

        local mime_type=""
        case "$ext" in
            http|https|ftp|mailto)
                mime_type="x-scheme-handler/$ext"
                ;;
            *)
                mime_type=$(xdg-mime query filetype "file.$ext")
                if [[ -z "$mime_type" ]]; then
                    echo "Warning: Could not determine MIME type for .$ext, skipping."
                    continue
                fi
                ;;
        esac

        echo "Setting default for $ext ($mime_type) to $desktop_file"
        xdg-mime default "$desktop_file" "$mime_type"
    done

    echo "Done."
}

case "$1" in
    starman)
        shift
        starman "$@"
        ;;
    --h|-h|help)
        show_help
        ;;
    default)
        set_default_app
        ;;
    refresh)
        update_app_list_cache
        echo "${GREEN}Starman app list refreshed.${RESET}"
        ;;
    ""|status)
        zenity_launcher
        ;;
     reset)
        reset_app_list
        ;;
    *)
        echo "${RED}Unknown command '$1'${RESET}"
        show_help
        exit 1
        ;;
esac
